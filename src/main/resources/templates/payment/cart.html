<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/agency.min.css" rel="stylesheet">
    <link href="/static/css/board.css" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Title</title>


</head>
<body style="width: fit-content">
<h1>장바구니</h1>

<!--<div><span th:text="${cartsum}"></span></div>-->
<form name="cartForm" id="cartForm" method="get" style="width:600px;">
    <div style="padding: 5px; border-top: 1px solid #d1d1d5; text-align: right"><span>총 개수 : </span><span th:text="${map.amount}"></span></div>
    <div th:each="cart:${map.cart}">
        <div style="height: 321px; padding-top: 20px; border-top: 1px solid #d1d1d5">
            <div style="float: left; position: relative"><img th:src="'/uploads/thumbnail/'+${cart.thumb_300}"></img></div>
            <div style="float: right"><img onclick="cartdelete(this)"th:attr="data-cart_no=${cart.cart_no}" src="/static/img/엑스.png"></div>
            <div style="padding-top: 20px"><span th:text="${cart.p_name}">상품이름</span></div>
            <div><span style="font-size: 12px; color: #6e707e">Option :</span> <span style="font-size: 12px; color: #6e707e" th:text="${cart.po_value}">옵션 이름</span></div>
            <div>
                <input type="checkbox" name="cart_no" th:value="${cart.cart_no}" checked/>
                <span>수량</span>
                <select name="cart_amount" id ="cart_quantity" >
                    <option name ="cart_amount" id = "cart_amount" th:each="i : ${#numbers.sequence(1,cart.po_stock)}" th:value="${i}" th:text="${i}" th:selected="${i==cart.cart_amount}"></option>
<!--                    <option name = "cart_amount" th:value="${cart.cart_amount}" th:text="${#numbers.sequence(1,cart.cart_amount)}"></option>-->
                </select>
                </div>
        </div>
        <div style="padding-bottom: 20px" id = "price">
            <div id = "p_price" style="border-top: 1px solid #d1d1d5; padding: 5px"><span>상품 가격:</span> <span th:text="${cart.p_price}+'x'+${cart.cart_amount}">상품 가격</span></div>
            <div style="border-bottom: 1px solid #d1d1d5; padding: 5px"><span>옵션 추가 가격:</span> <span th:text="${cart.po_price}">옵션 가격</span></div>
            <div style="border-bottom: 1px solid #d1d1d5; padding: 5px"><span>총 가격:</span> <span th:with="total =${cart.cart_amount*(cart.p_price+cart.po_price)}" th:text="${total}">총 가격</span></div>
        </div>
    </div>
</form>

    <div><span>결제 금액 : </span> <span th:text="${map.total}">상품 가격</span></div>
<input type="button" id = "cartBuy" value="주문 하기" onclick ="cartBuy()"/>

<script type="text/javascript" th:inline="javascript">


var cartdelete = function(obj){
    var cart_no = $(obj).data("cart_no");

    if(confirm("정말로 삭제하시겠습니까?")) {
        $.ajax({
            type: 'post',
            url: '/payment/cart/delete/' + cart_no,
            data: 'json',
            error: function (error) {
                console.error("Error!");
            },
            success: function (data) {
                console.log("success!");
                console.log(member.m_no);
                location.href = '/payment/cart/' + member.m_no;

            },
            complete: function () {
                console.log("complete!");
                window.location.reload(true);
            }
        });
    }
};

$( '#cart_quantity' ).change(function() {

var cart = /*[[${map.cart}]]*/;
$.each($('option[name ="cart_amount"]:checked'), function(index, obj) {
        
        console.log("hello world---------");
        var amount = $(obj).val();
        $('#p_price').remove()
        $('#price').append('<div id = \"p_price\" style=\"border-top: 1px solid #d1d1d5; padding: 5px\"><span>상품 가격:</span> <span th:text='+cart.p_price+"x"+amount+">상품 가격</span></div>\n');
        console.log($('#p_price').text());
        console.log("amount: " +amount);




})
});



    var cartBuy = function(){

    var cart_number =[];

    $.each($('input[name="cart_no"]:checked'), function(index,obj){
        console.log($(obj).val());
        $('#cartForm').append('<input type="hidden" name="cart_no_arr" value="'+$(obj).val()+'"/>');
        cart_number.push($(obj).val());
    });

    console.log(cart_number);
    var cart_amount = [];

    $.each($('option[name ="cart_amount"]:checked'), function(index, obj) {
        console.log($(obj).val());
        cart_amount.push($(obj).val());
    });
        console.log(cart_amount);

        $.ajax({
            type: 'post',
            url: '/payment/cartAmount',
            data: {"cart_number":cart_number, "cart_amount":cart_amount},
            error: function (error) {
                console.error("Error!");
            },
            success: function (data) {
                console.log("success!");
                console.log(data);
            },
            complete: function () {
                console.log("complete!");
            }
        });

    // $('#cartForm')
    //     .attr('action','/payment/cartBuy/')
    //     .attr('method','post')
    //     .submit();


    // var cart = /*[[${map.cart}]]*/;
    // var total =/*[[${map.total}]]*/;
    // console.log(cart);
    // var map = {cart:cart, total:total};
    // $.ajax({
    //     url : '/payment/cartBuy/',
    //     type : 'get',
    //     contentType: "application/json",
    //     data : JSON.stringify(map),
    //
    //     error : function(error){
    //         console.log("something wrong");
    //
    //     },
    //     success : function(){
    //         alert("결제페이지로 이동합니다.");
    //
    //     }
    // })

};

// console.log(cart);
// console.log(total);

</script>
</body>
</html>